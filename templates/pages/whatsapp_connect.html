{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Connect WhatsApp - {{ instance.instance_name }}{% endblock title %}

{% block content %}
<div class="pc-container">
  <div class="pc-content">
    <div class="page-header">
      <div class="page-block">
        <div class="row align-items-center">
          <div class="col-md-12">
            <div class="page-header-title">
              <h5 class="mb-0">Connect WhatsApp Instance</h5>
            </div>
          </div>
          <div class="col-md-12">
            <ul class="breadcrumb mb-0">
              <li class="breadcrumb-item"><a href="{% url 'apps.pages:index' %}">Home</a></li>
              <li class="breadcrumb-item"><a href="{% url 'apps.pages:credentials' %}">Credentials</a></li>
              <li class="breadcrumb-item" aria-current="page">Connect</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    <div class="row justify-content-center">
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header text-center">
            <h5 class="mb-0">
              <i class="ti ti-brand-whatsapp text-success me-2"></i>
              {{ instance.instance_name }}
            </h5>
            <p class="text-muted mb-0 mt-2">{{ instance.whatsapp_number }}</p>
          </div>
          <div class="card-body text-center">
            
            <!-- QR Container - Shows initially with data from session -->
            <div id="qr-container" {% if not qr_data %}class="d-none"{% endif %}>
              <p class="text-muted mb-3">Scan this QR code with WhatsApp on your phone</p>
              <div class="qr-code-wrapper mb-3">
                <img id="qr-image" src="{% if qr_data %}{{ qr_data.qr_base64 }}{% endif %}" alt="QR Code" class="img-fluid" style="max-width: 280px;">
              </div>
              {% if qr_data.pairing_code %}
              <div id="pairing-code-container">
                <p class="text-muted mb-2">Or use this pairing code:</p>
                <h3 id="pairing-code" class="text-primary font-monospace">{{ qr_data.pairing_code }}</h3>
              </div>
              {% else %}
              <div id="pairing-code-container" class="d-none">
                <p class="text-muted mb-2">Or use this pairing code:</p>
                <h3 id="pairing-code" class="text-primary font-monospace"></h3>
              </div>
              {% endif %}
              <button id="refresh-qr" class="btn btn-outline-secondary mt-3">
                <i class="ti ti-refresh me-1"></i> Refresh QR Code
              </button>
            </div>
            
            <!-- Loading state -->
            <div id="qr-loading" class="py-5 d-none">
              <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3 text-muted">Loading QR code...</p>
            </div>
            
            <!-- Error state -->
            <div id="qr-error" class="d-none py-5">
              <i class="ti ti-alert-circle text-danger" style="font-size: 48px;"></i>
              <p class="mt-3 text-danger" id="error-message">Failed to load QR code</p>
              <button id="retry-qr" class="btn btn-outline-primary mt-2">
                <i class="ti ti-refresh me-1"></i> Retry
              </button>
            </div>
            
            <!-- No QR data available - need to refresh -->
            {% if not qr_data %}
            <div id="no-qr-data" class="py-5">
              <i class="ti ti-qrcode text-muted" style="font-size: 48px;"></i>
              <p class="mt-3 text-muted">QR code expired or not available</p>
              <button id="load-qr" class="btn btn-success mt-2">
                <i class="ti ti-refresh me-1"></i> Load QR Code
              </button>
            </div>
            {% endif %}
            
          </div>
          <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
              <a href="{% url 'apps.pages:credentials' %}" class="btn btn-link text-muted">
                <i class="ti ti-arrow-left me-1"></i> Back to Credentials
              </a>
              <small class="text-muted">Click refresh if QR expires</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const instanceName = "{{ instance.instance_name }}";
    const refreshUrl = "{% url 'apps.pages:whatsapp_refresh_qr' instance.instance_name %}";
    
    const loadingEl = document.getElementById('qr-loading');
    const containerEl = document.getElementById('qr-container');
    const errorEl = document.getElementById('qr-error');
    const noQrDataEl = document.getElementById('no-qr-data');
    const qrImageEl = document.getElementById('qr-image');
    const pairingCodeEl = document.getElementById('pairing-code');
    const pairingCodeContainerEl = document.getElementById('pairing-code-container');
    const errorMessageEl = document.getElementById('error-message');
    
    function showState(state) {
        loadingEl.classList.add('d-none');
        containerEl.classList.add('d-none');
        errorEl.classList.add('d-none');
        if (noQrDataEl) noQrDataEl.classList.add('d-none');
        
        if (state === 'loading') loadingEl.classList.remove('d-none');
        else if (state === 'qr') containerEl.classList.remove('d-none');
        else if (state === 'error') errorEl.classList.remove('d-none');
    }
    
    function fetchQRCode() {
        showState('loading');
        
        fetch(refreshUrl)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    errorMessageEl.textContent = data.error;
                    showState('error');
                    return;
                }
                
                if (data.base64) {
                    qrImageEl.src = data.base64;
                    showState('qr');
                }
                
                if (data.pairingCode) {
                    pairingCodeEl.textContent = data.pairingCode;
                    pairingCodeContainerEl.classList.remove('d-none');
                } else {
                    pairingCodeContainerEl.classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('Error fetching QR code:', error);
                errorMessageEl.textContent = 'Network error. Please try again.';
                showState('error');
            });
    }
    
    // Manual refresh button
    const refreshBtn = document.getElementById('refresh-qr');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', fetchQRCode);
    }
    
    // Retry button
    const retryBtn = document.getElementById('retry-qr');
    if (retryBtn) {
        retryBtn.addEventListener('click', fetchQRCode);
    }
    
    // Load QR button (when no initial data)
    const loadBtn = document.getElementById('load-qr');
    if (loadBtn) {
        loadBtn.addEventListener('click', fetchQRCode);
    }
});
</script>
{% endblock javascripts %}
