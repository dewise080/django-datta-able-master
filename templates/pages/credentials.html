{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Credentials{% endblock title %}

{% block content %}
<div class="pc-container">
  <div class="pc-content">
    <div class="page-header">
      <div class="page-block">
        <div class="row align-items-center">
          <div class="col-md-12">
            <div class="page-header-title">
              <h5 class="mb-0">Credentials</h5>
            </div>
          </div>
          <div class="col-md-12">
            <ul class="breadcrumb mb-0">
              <li class="breadcrumb-item"><a href="{% url 'apps.pages:index' %}">Home</a></li>
              <li class="breadcrumb-item" aria-current="page">Credentials</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    <!-- Telegram Section -->
    <h5 class="mb-3"><i class="ti ti-brand-telegram text-info me-2"></i>Telegram</h5>
    <div class="row mb-4">
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Connect Telegram</h5>
            {% if not has_api_key %}
              <span class="badge bg-warning text-dark ms-2">Missing API key</span>
            {% endif %}
          </div>
          <div class="card-body">
            <p class="text-muted">Enter a friendly name and your Telegram bot token to sync a credential into n8n.</p>
            <form method="post" class="row g-3">
              {% csrf_token %}
              <input type="hidden" name="form_type" value="telegram">
              <div class="col-12">
                <label class="form-label">Name</label>
                <input type="text" name="name" class="form-control" placeholder="My Telegram bot" required>
              </div>
              <div class="col-12">
                <label class="form-label">Telegram Token</label>
                <input type="text" name="token" class="form-control" placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11" required>
              </div>
              <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary" {% if not has_api_key %}disabled{% endif %}>Save to n8n</button>
              </div>
            </form>
            {% if not has_api_key %}
              <p class="mt-3 text-danger">
                {% if not has_profile %}
                  No n8n profile linked to your account. Please contact support to link your account.
                {% else %}
                  No n8n API key found for your account. Please ensure your account is linked.
                {% endif %}
              </p>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Saved Telegram Credentials</h5>
          </div>
          <div class="card-body">
            {% if credentials %}
              <div class="table-responsive">
                <table class="table mb-0">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>n8n ID</th>
                      <th>Created</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for cred in credentials %}
                      <tr>
                        <td>{{ cred.name }}</td>
                        <td><code>{{ cred.n8n_credential_id }}</code></td>
                        <td>{{ cred.created_at }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="mb-0 text-muted">No Telegram credentials saved yet.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- WhatsApp Section -->
    <h5 class="mb-3"><i class="ti ti-brand-whatsapp text-success me-2"></i>WhatsApp</h5>
    <div class="row">
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Connect WhatsApp</h5>
          </div>
          <div class="card-body">
            <p class="text-muted">Enter a unique instance name and your WhatsApp number to create a new connection.</p>
            <form method="post" class="row g-3">
              {% csrf_token %}
              <input type="hidden" name="form_type" value="whatsapp">
              <div class="col-12">
                <label class="form-label">Instance Name</label>
                <input type="text" name="instance_name" class="form-control" placeholder="my-whatsapp-bot" required pattern="[a-zA-Z0-9_-]+" title="Only letters, numbers, underscores and hyphens allowed">
                <small class="text-muted">Only letters, numbers, underscores and hyphens allowed</small>
              </div>
              <div class="col-12">
                <label class="form-label">WhatsApp Number</label>
                <input type="text" name="whatsapp_number" class="form-control" placeholder="+1234567890" required>
                <small class="text-muted">Include country code (e.g., 90 for Turkey 90xxxxxxxx , 1 for USA 1xxxxxxxxxx)</small>
              </div>
              <div class="col-12 text-end">
                <button type="submit" class="btn btn-success">
                  <i class="ti ti-brand-whatsapp me-1"></i> Create Instance
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">WhatsApp Instances</h5>
          </div>
          <div class="card-body">
            {% if whatsapp_instances %}
              <div class="table-responsive">
                <table class="table mb-0">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Number</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for instance in whatsapp_instances %}
                      <tr>
                        <td>{{ instance.instance_name }}</td>
                        <td>{{ instance.whatsapp_number }}</td>
                        <td>
                          {% if instance.status == "connected" %}
                            <span class="badge bg-success">Connected</span>
                          {% elif instance.status == "pending" %}
                            <span class="badge bg-warning text-dark">Pending</span>
                          {% else %}
                            <span class="badge bg-secondary">Disconnected</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if instance.status != "connected" %}
                            <a href="{% url 'apps.pages:whatsapp_connect' instance.instance_name %}" class="btn btn-sm btn-outline-primary">
                              <i class="ti ti-qrcode"></i> Connect
                            </a>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="mb-0 text-muted">No WhatsApp instances created yet.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}
